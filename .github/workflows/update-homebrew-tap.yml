name: Update Homebrew Tap

on:
  repository_dispatch:
    types: [update-homebrew]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  update-homebrew-tap:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4

    - name: Extract or set version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
          TAG="v$VERSION"
          echo "🔧 Manual trigger with version: $VERSION"
        elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          VERSION="${{ github.event.client_payload.version }}"
          TAG="${{ github.event.client_payload.tag }}"
          echo "🤖 Repository dispatch trigger with version: $VERSION"
        else
          echo "❌ Unsupported event type: ${{ github.event_name }}"
          exit 1
        fi
        
        # Remove 'v' prefix from version if present
        VERSION="${VERSION#v}"
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        
        echo "Version: $VERSION"
        echo "Tag: $TAG"

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Clone Homebrew tap repository
      run: |
        # Clone homebrew-tap repository with authentication
        git clone https://${{ secrets.PAT }}@github.com/hungthai1401/homebrew-tap.git homebrew-tap
        
    - name: Generate Homebrew formula using Node.js script
      run: |
        # Run the Node.js script to generate the formula file
        echo "🚀 Generating Homebrew formula..."
        node .github/workflows/scripts/generate-homebrew.js ${{ steps.version.outputs.version }}
      env:
        OCCTX_VERSION: ${{ steps.version.outputs.version }}

    - name: Verify formula was updated
      run: |
        echo "🔍 Verifying formula update was successful..."
        cd homebrew-tap
        
        if [ -f "Formula/occtx.rb" ]; then
          echo "✅ Formula file exists"
          
          # Check if version was updated
          if grep -q "version \"${{ steps.version.outputs.version }}\"" Formula/occtx.rb; then
            echo "✅ Version updated successfully"
          else
            echo "❌ Version was not updated"
            exit 1
          fi
          
          # Basic syntax check if Ruby is available
          if command -v ruby >/dev/null 2>&1; then
            echo "🔍 Running Ruby syntax check..."
            if ruby -c Formula/occtx.rb 2>/dev/null; then
              echo "✅ Ruby syntax check passed"
            else
              echo "❌ Ruby syntax check failed"
              echo "📄 Formula content for debugging:"
              cat Formula/occtx.rb
              exit 1
            fi
          else
            echo "⚠️ Ruby not available, skipping syntax check"
            echo "📝 Note: Formula syntax will be validated when users install via Homebrew"
            echo "🔍 Basic file validation..."
            
            # Basic validation without Ruby
            if grep -q "class Occtx < Formula" Formula/occtx.rb; then
              echo "✅ Formula class definition found"
            else
              echo "❌ Formula class definition not found"
              exit 1
            fi
            
            if grep -q "def install" Formula/occtx.rb; then
              echo "✅ Install method found"
            else
              echo "❌ Install method not found"
              exit 1
            fi
            
            if grep -q "sha256" Formula/occtx.rb; then
              echo "✅ SHA256 hashes found"
            else
              echo "❌ SHA256 hashes not found"
              exit 1
            fi
            
            echo "✅ Basic formula validation passed"
          fi
          
          echo "📄 Final formula content:"
          cat Formula/occtx.rb
        else
          echo "❌ Formula file not found"
          exit 1
        fi

    - name: Commit and push changes to Homebrew tap
      run: |
        cd homebrew-tap

        # Set the remote URL with the token
        git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/hungthai1401/homebrew-tap.git
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Check if there are changes to commit
        if git diff --quiet; then
          echo "ℹ️  No changes to commit"
          exit 0
        fi
        
        # Add changes
        git add .
        
        # Create commit message with version details
        cat > commit_message.txt << EOF
        Update occtx to version ${{ steps.version.outputs.version }}

        - Version: ${{ steps.version.outputs.version }}
        - Release: https://github.com/hungthai1401/occtx/releases/tag/v${{ steps.version.outputs.version }}
        
        Auto-updated by GitHub Actions
        EOF
        
        # Commit and push
        git commit -F commit_message.txt
        git push origin main
        
        echo "✅ Successfully pushed changes to homebrew-tap repository"
